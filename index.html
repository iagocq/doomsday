<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doomsday trainer</title>
    <style>
        .guess-correct {
            color: lightgreen;
        }
        .guess-incorrect {
            color: lightcoral;
        }
    </style>
</head>
<body>
    <p>Year: <span id="year">XXXX</span></p>
    <p>Date: <span id="day">XX</span>/<span id="month">XX</span></p>
    <p>Play a round by pressing Enter</p>
    <p>Day of Week: <span id="guess" class="guess-neutral">X</span> (guessed) / <span id="correct-dow">X</span> (correct)</p>
    <p>Score: <span id="correct">0</span> / <span id="total">0</span> (<span id="ratio">1</span>)</p>
    <p>Streak: <span id="streak">0</span></p>
    <p>Average Time (last 5): <span id="avg-time">0</span>s</p>
    <p>Last Time: <span id="last-time">0</span>s</p>
    <input type="checkbox" id="only-doomsday">
    <label for="only-doomsday">Only guess Doomsday</label>
    <script>
        let stats = {
            correct: 0,
            total: 0,
            streak: 0,
            times: [],
            corrects: [],
            whens: [],
            onlyDoomsdays: []
        };

        let options = {
            minYear: 1900,
            maxYear: 2099,
            sundayIs: 1,
            onlyGuessDoomsday: true,
        };

        let state = {
            date: 0,
            playing: false,
            startedAt: 0,
        };

        function now() {
            return new Date().getTime() / 1000;
        }

        function guessDay(guess) {
            const time = now() - state.startedAt;

            const dayOfWeek = options.onlyGuessDoomsday ? getDoomsday(state.date) : getDayOfWeek(state.date);

            stats.total += 1;

            setContent('guess', guess);
            setContent('correct-dow', dayOfWeek);

            const guessEl = getElement('guess');

            const correct = (guess%7) == dayOfWeek;
            if (correct) {
                guessEl.className = 'guess-correct';
                stats.streak += 1;
                stats.correct += 1;
            } else {
                guessEl.className = 'guess-incorrect';
                stats.streak = 0;
            }

            stats.times.push(time);
            stats.corrects.push(+correct);
            stats.whens.push(Math.floor(state.startedAt));
            stats.onlyDoomsdays.push(+options.onlyGuessDoomsday);

            saveStats();
            displayStats();
        }
        
        function getDayOfWeek(date) {
            return (date.getDay() + options.sundayIs)%7;
        }

        function getDoomsday(date) {
            const d = new Date(date.getFullYear(), 2, 14); // 3/14, Pi Day
            return getDayOfWeek(d);
        }

        function getElement(id) {
            return document.getElementById(id);
        }

        function setContent(id, val) {
            document.getElementById(id).innerText = val;
        }

        function displayStats() {
            setContent('correct', stats.correct);
            setContent('total', stats.total);
            const ratio = stats.total == 0 ? 1 : (stats.correct / stats.total).toFixed(3);
            setContent('ratio', ratio);
            setContent('streak', stats.streak);
            const n = 5;
            const nTimes = Math.min(n, stats.times.length);
            if (nTimes > 0) {
                const totalTime = stats.times.slice(-n).reduce((p, v) => p + v, 0);
                const avg = nTimes == 0 ? 0 : (totalTime / nTimes);
                setContent('avg-time', (totalTime / nTimes).toFixed(2));
                setContent('last-time', stats.times[stats.times.length-1].toFixed(2));
            }
        }

        function displayOptions() {
            getElement('only-doomsday').checked = options.onlyGuessDoomsday;
        }

        function loadFromStorage(key) {
            const st = localStorage.getItem(key);
            if (st == null) return null;
            return JSON.parse(st);
        }

        function saveToStorage(key, val) {
            localStorage.setItem(key, JSON.stringify(val));
        }

        function loadStats() {
            stats = Object.assign(stats, loadFromStorage('doomsday-stats'));
        }

        function loadOptions() {
            options = Object.assign(options, loadFromStorage('doomsday-options'));
            getElement('only-doomsday').checked = options.onlyGuessDoomsday;
        }

        function saveStats() {
            saveToStorage('doomsday-stats', stats);
        }

        function saveOptions() {
            saveToStorage('doomsday-options', options);
        }

        function random(min, max) {
            const range = max - min;
            return Math.floor(Math.random() * range + min);
        }

        function newRound() {
            const year = random(options.minYear, options.maxYear+1);

            const isLeapYear = year % 4 == 0 && (year % 100 != 0 || year % 400 == 0);
            const dateRange = isLeapYear ? 366 : 365;
            const date = random(0, dateRange);

            const timestamp = new Date(year, 0).getTime() + date * 24 * 3600 * 1000;
            state.date = new Date(timestamp);

            setContent('year', state.date.getFullYear());
            if (!options.onlyGuessDoomsday) {
                setContent('day', state.date.getDate());
                setContent('month', state.date.getMonth() + 1);
            } else {
                setContent('day', 'XX');
                setContent('month', 'XX');
            }

            setContent('guess', 'X');
            setContent('correct-dow', 'X');
            getElement('guess').className = 'guess-neutral';
        }

        document.addEventListener('keypress', ev => {
            const k = ev.which;
            const n = k - 0x30;
            const guessed = state.playing && n >= 0 && n <= 9;
            if (guessed) {
                guessDay(n);
            }
            if (guessed || k == 10 || k == 13) {
                state.playing = !state.playing;
                state.startedAt = now();
                if (state.playing) {
                    newRound();
                }
            }
        });

        getElement('only-doomsday').addEventListener('change', ev => {
            const el = ev.srcElement;
            options.onlyGuessDoomsday = el.checked;
            saveOptions();
            displayOptions();
        });

        loadStats();
        loadOptions();
        displayStats();
        displayOptions();
    </script>
</body>
</html>
